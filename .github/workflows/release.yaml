name: Release
on:
    push:
      tags:
        - 'v*'

permissions:
    contents: write
    pages: write
    id-token: write

jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: '1.21'

        - name: Install tools
          run: |
            echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
            sudo apt update
            sudo apt install -y nfpm createrepo-c

        - name: Build binaries
          run: |
            VERSION=${GITHUB_REF#refs/tags/v}
            mkdir -p dist

            go mod tidy

            GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o dist/health-agent_linux_amd64 ./cmd/agent
            GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o dist/health-agent_linux_arm64 ./cmd/agent

        - name: Create packages
          run: |
            VERSION=${GITHUB_REF#refs/tags/v}

            # amd64 RPM
            cat > nfpm-amd64.yaml << EOF
            name: health-agent
            arch: x86_64
            platform: linux
            version: ${VERSION}
            maintainer: LodongDev <dev@lodong.com>
            description: Service health monitoring agent
            vendor: LodongDev
            homepage: https://github.com/LodongDev/health-agent
            license: MIT
            contents:
              - src: dist/health-agent_linux_amd64
                dst: /usr/bin/health-agent
                file_info:
                  mode: 0755
            EOF
            nfpm pkg --packager rpm --config nfpm-amd64.yaml --target dist/

            # arm64 RPM
            cat > nfpm-arm64.yaml << EOF
            name: health-agent
            arch: aarch64
            platform: linux
            version: ${VERSION}
            maintainer: LodongDev <dev@lodong.com>
            description: Service health monitoring agent
            vendor: LodongDev
            homepage: https://github.com/LodongDev/health-agent
            license: MIT
            contents:
              - src: dist/health-agent_linux_arm64
                dst: /usr/bin/health-agent
                file_info:
                  mode: 0755
            EOF
            nfpm pkg --packager rpm --config nfpm-arm64.yaml --target dist/

            # tar.gz
            cd dist
            cp health-agent_linux_amd64 health-agent && tar -czvf health-agent_${VERSION}_linux_amd64.tar.gz health-agent && rm health-agent
            cp health-agent_linux_arm64 health-agent && tar -czvf health-agent_${VERSION}_linux_arm64.tar.gz health-agent && rm health-agent

        - name: Create YUM repository
          run: |
            mkdir -p yum-repo/rpm
            cp dist/*.rpm yum-repo/rpm/
            createrepo_c yum-repo/rpm/

            cat > yum-repo/health-agent.repo << 'EOF'
            [health-agent]
            name=Health Agent Repository
            baseurl=https://lodongdev.github.io/health-agent/rpm
            enabled=1
            gpgcheck=0
            EOF

            cat > yum-repo/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head><title>Health Agent Repository</title></head>
            <body>
            <h1>Health Agent YUM Repository</h1>
            <pre>
            sudo curl -o /etc/yum.repos.d/health-agent.repo https://lodongdev.github.io/health-agent/health-agent.repo
            sudo yum install health-agent
            </pre>
            </body>
            </html>
            EOF

        - name: Deploy to GitHub Pages
          uses: peaceiris/actions-gh-pages@v4
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./yum-repo

        - name: Create GitHub Release
          uses: softprops/action-gh-release@v1
          with:
            files: |
              dist/*.tar.gz
              dist/*.rpm
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
